# =====  ANSIBLE  ============================================================
#          NAME:  roles/dotfiles/tasks/handle-gpg-keys.yml
#   DESCRIPTION:  Primary entry point for this play
# ============================================================================
---
- name: "Create symbolic link for GnuPG"
  ansible.builtin.file:
    src: "{{ install.base_path }}/config/dotfiles/gnupg"
    dest: "{{ ansible_user_dir }}/.gnupg"
    state: link
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0700"

- name: "Create private keys directory"
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.gnupg/private-keys-v1.d/"
    state: directory
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0700"

- name: "Search for existing private keys"
  ansible.builtin.find:
    paths: "{{ ansible_user_dir }}/.gnupg/private-keys-v1.d/"
    patterns: "*.key"
    file_type: "file"
    recurse: false
  register: "dotfiles_gpg_keys_files_found"

- name: "Create GPG private key (if provided)"
  ansible.builtin.copy:
    content: "{{ user_account.gpg.gpg_key }}"
    dest: "{{ install.tmpdir | default(ansible_user_dir) }}/privkey.asc"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0600"
  when:
    - dotfiles_gpg_keys_files_found.files | count == 0
    - user_account.gpg.generate_keys is false
    - user_account.gpg.fetch_keys is false
    - user_account.gpg.key | length > 0

- name: "Define GPG batch configuration file content"
  ansible.builtin.template:
    src: "templates/config/gnupg/config.j2"
    dest: "{{ install.tmp_dir | default(ansible_user_dir) }}/input.txt"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0600"
  when:
    - dotfiles_gpg_keys_files_found.files | count == 0
    - user_account.gpg.generate_keys is true
    - user_account.gpg.fetch_keys is false
    - user_account.gpg.key_type is defined
    - user_account.gpg.key_length is defined
    - user_account.name is defined
    - user_account.email is defined
    - user_account.gpg.expiry is defined
    - user_account.gpg.passphrase is defined

- name: "Generate the GPG key pair using batch mode"
  ansible.builtin.command:
    cmd: "gpg --batch --gen-key {{ install.tmp_dir | default(ansible_user_dir) }}/input.txt"
    creates: "{{ ansible_user_dir }}/.gnupg/trustdb.gpg"
  when:
    - dotfiles_gpg_keys_files_found.files | count == 0
    - user_account.gpg.generate_keys is true
    - user_account.gpg.fetch_keys is false

- name: "Save service account file (Google Cloud)"
  ansible.builtin.copy:
    content: "{{ secrets.google.GCP_SERVICE_ACCOUNT }}"
    dest: "{{ install.tmp_dir | default(ansible_user_dir) }}/service_account.json"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0600"
  when:
    - user_account.gpg.fetch_keys is true
    - user_account.ssh.key_source == "gcloud"
    - secrets.google.GCP_SERVICE_ACCOUNT is defined
    - secrets.google.GCP_SERVICE_ACCOUNT | length > 0
    - dotfiles_gpg_keys_files_found is undefined or dotfiles_gpg_keys_files_found.files | count == 0

- name: "Get GPG Private Key (Google Cloud)"
  vars:
    auth_kind: "serviceaccount"
    service_account_file: "{{ install.tmp_dir | default(ansible_user_dir) }}/service_account.json"
    project: "{{ gcp.projects.project_id }}"
    secret_id: "{{ user_account.gpg.key_id }}"
    dotfiles_gpg_private_key_output: "{{ lookup('google.cloud.gcp_secret_manager', project=project, auth_kind=auth_kind, service_service_account_file=service_account_file, key=secret_id) }}"
  ansible.builtin.debug:
    msg: "Fetching key from Google Cloud"
  when:
    - user_account.gpg.fetch_keys is true
    - user_account.gpg.key_source == "gcloud"
    - secrets.google.GCP_SERVICE_ACCOUNT is defined
    - secrets.google.GCP_SERVICE_ACCOUNT | length > 0
    - gcp.projects.project_id is defined
    - gcp.projects.project_id | length > 0
    - dotfiles_key_exists is undefined or dotfiles_key_exists.stat.exists is false

- name: "Get GPG Private Key (Bitwarden Secrets)"
  vars:
    bws_access_token: "{{ secrets.bitwarden.BW_ACCESS_TOKEN }}"
    secret_id: "{{ user_account.gpg.key_id }}"
    bw_vault_url: "https://vault.bitwarden.eu/"
    dotfiles_gpg_private_key_output: "{{ lookup('bitwarden.secrets.lookup', secret_id, access_token=bws_access_token, base_url=bw_vault_url) }}"
  ansible.builtin.debug:
    msg: "Fetching key from Bitwarden Secrets"
  when:
    - user_account.gpg.fetch_keys is true
    - user_account.ssh.key_source == "bitwarden"
    - secrets.bitwarden.BW_ACCESS_TOKEN is defined
    - secrets.bitwarden.BW_ACCESS_TOKEN | length > 0
    - dotfiles_key_exists is undefined or dotfiles_key_exists.stat.exists is false

- name: "Save fetched GPG private key file"
  ansible.builtin.copy:
    content: "{{ dotfiles_gpg_private_key_output.value }}"
    dest: "{{ install.tmp_dir | default(ansible_user_dir) }}/privkey.asc"
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
    mode: "0600"
  when:
    - user_account.gpg.fetch_keys is true
    - dotfiles_gpg_keys_files_found.files | count == 0
    - dotfiles_gpg_private_key_output.value | length > 0

- name: "Import fetched GPG private key"
  ansible.builtin.command:
    argv:
      - "gpg"
      - "--batch"
      - "--passphrase"
      - "{{ user_account.gpg.passphrase }}"
      - "--import"
      - "{{ install.tmp_dir | default(ansible_user_dir) }}/privkey.asc"
    creates: "{{ ansible_user_dir }}/.gnupg/private-keys-v1.d/*.key"
  when:
    - user_account.gpg.fetch_keys is true
    - user_account.gpg.generate_keys is false
    - user_account.gpg.passphrase is defined
    - user_account.gpg.passphrase | length > 0
    - dotfiles_gpg_keys_files_found.files | count == 0

- name: "Capture the key ID"
  ansible.builtin.command:
    cmd: "{{ role_path }}/files/scripts/get_gpg_key.sh"
  changed_when: false
  register: dotfiles_get_gpg_key
  when:
    - user_account.gpg.generate_keys is true
    - user_account.gpg.fetch_keys is false

- name: "Remove temporary GPG files"
  ansible.builtin.file:
    path: "{{ rm_gpg_temp_item }}"
    state: absent
  loop:
    - "{{ install.tmp_dir | default(ansible_user_dir) }}/privkey.asc"
    - "{{ install.tmp_dir | default(ansible_user_dir) }}/service_account.json"
    - "{{ install.tmp_dir | default(ansible_user_dir) }}/input.txt"
  loop_control:
    loop_var: "rm_gpg_temp_item"
