# =====  ANSIBLE  ============================================================
#          NAME:  site.yml
#   DESCRIPTION:  Entry point for playbook
# ============================================================================
---
- name: Deploy and install dotfiles

  pre_tasks:
    - name: Pre-installation cleanup
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ common_installer_path }}"
        - "{{ common_checkout_path }}"

    - name: Create temporary directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0700'
      with_items:
        - "{{ common_installer_path }}"
        - "{{ common_checkout_path }}"

  hosts: user_defined
  become: true
  become_user: "{{ common_remote_username }}"
  tasks:
    - name: Run common role
      ansible.builtin.include_role:
        name: common
    - name: Run custom roles
      ansible.builtin.include_role:
        name: "{{ item }}"
      with_items:
        - install_dotfiles

  post_tasks:
    - name: Post-installation cleanup
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      with_items:
        - "{{ common_checkout_path }}"
        - "{{ common_setup_path }}"
