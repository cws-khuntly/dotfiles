https://docs.fedoraproject.org/en-US/quick-docs/using-kubernetes-kubeadm/

sudo dnf update
sudo systemctl disable --now swap-create@zram0 firewalld
sudo dnf remove zram-generator-defaults

sudo cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
fs.inotify.max_user_watches         = 2099999999
fs.inotify.max_user_instances       = 2099999999
fs.inotify.max_queued_events        = 2099999999
fs.file-max                         = 2099999999

kernel.pid_max                      = 10485760
kernel.threads-max                  = 10485760

net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

sudo reboot

sudo dnf install iptables iproute-tc cri-o1.35 containernetworking-plugins kubernetes1.35 kubernetes1.35-kubeadm kubernetes1.35-client kubernetes1.35-systemd k9s helm

curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

sudo systemctl enable --now cri-o kubelet
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --cri-socket unix:///var/run/crio/crio.sock

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

kubectl taint nodes --all node-role.kubernetes.io/control-plane-
kubectl apply -f https://github.com/coreos/flannel/raw/master/Documentation/kube-flannel.yml

helm repo add traefik https://traefik.github.io/charts
helm repo update

kubectl create ns traefik
helm install traefik traefik/traefik --namespace traefik

kubectl get pods -n traefik
kubectl get svc -n traefik

k3d registry create fedora.local --port 65000

sudo mkdir /etc/docker
sudo cat <<EOF | sudo tee /etc/docker/daemon.json
{
  "insecure-registries": ["k3d-fedora.local:65000"]
}
EOF

sudo systemctl restart docker

k3d cluster create fedora --agents 2 --port "8180:80@loadbalancer" --port "8143:443@loadbalancer" --registry-use k3d-registry.fedora.local:65000 --wait

kubectl config set-credentials admin@k3d-fedora --username admin@k3d-fedora

kubectl config set-cluster k3d-fedora --insecure-skip-tls-verify=true

kubectl apply -f ~/.dotfiles/config/kubernetes/cwsna-server.yml -n kube-system

helm repo add traefik https://traefik.github.io/charts
helm repo update

kubectl create namespace traefik
helm install traefik traefik/traefik --namespace traefik

kubectl create namespace fedora

kubectl config set-context --current --namespace fedora
